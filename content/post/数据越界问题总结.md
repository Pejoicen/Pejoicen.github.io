---
title: "数据越界问题总结"
date: 2019-10-22T10:31:43+08:00
description: ""
draft: false
tags: ["MFC","越界"]
categories: ["软件"]
---

数据越界问题总结
<!--more-->

# **数据越界问题总结**

1.软件运行时数据明显被篡改，关闭时释放资源失败。**此类问题，一般都是栈被破坏，主要是查看出现错误地方用到的栈(比如数组)在使用过程中是否有越界。**

> 数组和字符串的名称都是指针，当其下标越界时就会出现数据访问越界的情况。因此尤其需要注意。

2.另外像这种有尺寸的buf，在用的时候对存入的数据大小做一个限制，超出限制时需要报出相关信息。

> 比如说strcpy字符串拷贝函数和memcpy内存拷贝函数，以及sprintf打印函数，打印信息时不会检查数据的长度信息。

>
    > 1. Strcpy函数可以用strncpy_s函数替代。
>2. 将接收数据存到一个buf中，现在一直都没有检查存入的数据长度是否会超过我们声明buf的长度。

3.定位问题的方法

> 1. 通过调用堆栈来定位具体出错的代码位置；
> 2. 添加监视来观察变量的数值变化；
> 3. 在内存窗口中直接观察内存中一定区域内的数值。

# 问题1测试记录

上位机版本：RTTC_SS_20190916，FPGA版本：2019091501

1.  保通道设备自环，用前端模拟软件发送遥控数据，远控接收数据
2.  参数：2047，-30，±180KHz，15KHz/s，正弦扫描，16384，10.23，关，关，关，L码，EC175D39，512.（遥控模拟端帧长设置为1024，测试可变帧长）

## 问题现象

1.  远控遥控收令和基带遥控发令的条数一致保持一致。

2.  基带遥测收数会有1-2帧的丢帧，远控遥测发数一直为0.

3.  当基带遥测收数的条数满了时，提示“TM数据队列满”，四个控件中的数值显示都会突然变得很大，然后远控遥控收令、基带遥控发令、基带遥测收数还能继续加1向上增长。

![](/media-数据越界问题总结/f840a7bb7d05f6315b1811b417da78d1.png)

![](/media-数据越界问题总结/219ed3658e940d4204e3ffa0795b439a.png)

1.  出现计数值的错误后，关闭上位机出现异常中断。

![IMG_256](/media-数据越界问题总结/6797b4e205e5268b371881a316179d89.png)

## 测试计划和情况

1.  关闭数据快视，看看会不会出错；
    * 没有数据快视，也会出错。
2.  去掉插入发送队列再看看是否会出错。
    * 去掉插入发送队列也会出错。
3.  增加测试代码和断点，当数据异常时触发中断。

    * 发现问题出现在上位机接收到FPGA数据前；

![](/media-数据越界问题总结/2c21873290afb879d042ecd2b9d82996.png)

1.  出错时我们发送的是固定码0x37，基带遥测收数变量的g_FpgaRecvTM_Num变量的值为0x33373337，怀疑是有数据的越界，因为0x37用ASCII码表示是0x3337；

2.  当我们将固定码更改为0x38，出错时g_FpgaRecvTM_Num变量的值为0x33383338；固定码更改为0x28，出错时g_FpgaRecvTM_Num变量的值为0x32383238。

3.  通过加断点验证，发现出现问题的地方是在前一次正常接收数据之后，这一次还未开始的地方；应该是接收数据的队列有越界的地方，最后发现将向窗口输出本次接收数据内容的代码主是时候，可以避免上述问题，排查到是接收以太网数据，存储打印数据内容的buf开的太小了。

4.  更换bit文件为090701版本，将遥控模拟帧长设置为512，观察是否能正常收发数据。

    1.  测试发现也会出现上述问题。

![](/media-数据越界问题总结/447b71c4d0c0d17401171e13147c6550.png)

## 问题原因和解决方法

1.  因为将接收数据打印到信息显示栏，需要将二进制数据转换为ASCII码字符形式，一字节需要用2字符来显示，这也就解释了存储打印数据内容的buf数据越界，导致计数变量显示的错误值的问题。

2.  TCtcpListen.cpp文件中，打印信息的地方注释掉之后，发现没有再出现上述问题，进入InsertStrInfoToTeam函数中发现g_strInfoTeamIn-\>strInfoBuf数组的容量只有1024，但是我们发送的数据帧长度为512字节，再加上一些打印的字，已经超出了此数据组的容量。**此处数据越界。**

![](/media-数据越界问题总结/e95b2314c2354477008809e4f500a005.png)

![](/media-数据越界问题总结/edd7ec23c32751cd0e128522786434c2.png)

1.  将数组容量更改为3072，根据大于以太网传输最大包长2倍定义。

2.  更改过后，再次测试上述问题已经修复。

# 问题2测试记录

USB上位机远控切换为本控时出现异常中断，并提示：0xC0000008: An invalid handle was specified

打开设备前，将参数设置为“远控”模式。打开设备后，自动启动远控模式。

启动时可以看到HANDLE变量值为0xFFFFFFFF.

![](/media-数据越界问题总结/535122fa8f2aa4168a9f88804abd6a5e.png)

创建后，各个HANDLE数值如下：

![](/media-数据越界问题总结/3896959ec755fead77cb593424567187.png)

界面上点击“本控”按钮后，发现数值变化！如图所示，在该断点处，通过监视窗口可以看到g_hMainThreadExitEvent[5]和g_hMainThreadExitEvent[8]的值和其余相差较大。

![](/media-数据越界问题总结/acf16e00d813c4421143a4eb1c5bd083.png)

当执行到CloseHandle时，出现0xC0000008: An invalid handle was specified错误。

继续定位问题的具体位置。

发现启动后，不点击“本控”控件，而是点击“关闭设备”控件，发现也会出错。

![](/media-数据越界问题总结/4853fd962f663a91895c96fdedab9dcd.png)

重试一遍，发现“本控”按钮的函数开始执行时，已经出现问题。

![](/media-数据越界问题总结/cbfbb967b3f790b65f6a06c73e1ec067.png)

晚上继续测试

发现处于远控模式关闭上位机后，再启动上位机并打开设备，上位机自动进入远控模式。待上位机启动远控完毕后，直接在菜单-\>调试-\>全部中断上位机运行，发现从**内存窗口**中观察到数据已经出错。

![](/media-数据越界问题总结/852786bed53e001c041c956fd8775a5c.png)

发现出错的数据是“RF：”，发现是主界面更新工作模式时会显示射频板卡的设备号。而机箱中没有射频卡时，显示的就是“RF：”，将这部分注释掉之后就不会有这个问题。

![](/media-数据越界问题总结/b302b34f96f9db1c34c5a38879723cec.png)

逐步调试：

![](/media-数据越界问题总结/b10258e0030ea979b4c122c9010cc17a.png)

增加赋值为””

![](/media-数据越界问题总结/6f1e4282d3fd04d0488a9f26bb63c554.png)

之后，发现地址不再和handle地址冲突，变为

![](/media-数据越界问题总结/dd063404b9b7d8c20079280ddbb67f09.png)

![](/media-数据越界问题总结/8a3411becea9a7a71ae17f5fbab058d6.png)

**真正的原因是射频卡不存在的时候ID返回值是-1，导致数组越界。**